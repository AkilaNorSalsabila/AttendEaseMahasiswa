<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Absensi</title>

    <!-- Custom fonts for this template -->
    <link href="/static/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    
    <!-- Custom styles for this template -->
    <link href="/static/css/sb-admin-2.min.css" rel="stylesheet">
    <!-- Bootstrap core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <style>
        .modal-header, .modal-body, .modal-footer {
            padding: 15px;
        }
    </style>
        <!-- Tambahkan di bagian <style> -->
        <style>
        /* Style untuk bottom bar */
        #bottomBar {
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        #bottomBar .bg-success, 
        #bottomBar .bg-danger {
            padding: 0.75rem 1.5rem;
        }
        
        /* Animasi saat muncul/hilang */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
        
        #bottomBar[style*="display: flex"] {
            animation: fadeIn 0.3s forwards;
        }
        
        #bottomBar[style*="display: none"] {
            animation: fadeOut 0.3s forwards;
        }
        
        /* Style untuk tabel di modal */
        #modalAmbilGaji .table {
            margin-bottom: 0;
        }
        
        #modalAmbilGaji .card {
            margin-bottom: 1rem;
        }
        
        #modalAmbilGaji .card-header {
            padding: 0.5rem 1rem;
        }
        #btnProsesAmbilGaji[disabled] {
            opacity: 0.7;
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
        }

    </style>
        <!-- Firebase JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>

    </script>            
</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/dashboard">
                <div class="sidebar-brand-text mx-3">Admin Dashboard</div>
            </a>
            <hr class="sidebar-divider">
            <li class="nav-item">
                <a class="nav-link" href="/dashboard">
                    <i class="fas fa-database"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/dataset">
                    <i class="fas fa-database"></i>
                    <span>Tambah Dataset</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/train">
                    <i class="fas fa-brain"></i>
                    <span>Training Model</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/attendance">
                    <i class="fas fa-list"></i>
                    <span>Karyawan Attendance</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/jadwal_kerja">
                    <i class="fas fa-calendar"></i>
                    <span>Jadwal Kerja</span>
                </a>
            </li>
            <li class="nav-item active">
                <a class="nav-link" href="/admin/penggajian">
                    <i class="fas fa-calendar"></i>
                    <span>Penggajian</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link logout" href="/logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </li>
        </ul>

        <!-- Content Wrapper -->
        <div class="container-fluid">
            <h1 class="h3 mb-4 text-gray-800 text-center">Data Gaji Karyawan</h1>

            <!-- Form Filter Nama Karyawan + Tanggal -->
            <div class="card mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Filter Data</h6>
                </div>
                <div class="card-body">
                    <form method="POST" action="/admin/penggajian" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="nama_karyawan" class="form-label">Nama Karyawan:</label>
                            <select name="nama_karyawan" id="nama_karyawan" class="form-control">
                                <option value="">Semua Karyawan</option>
                                {% for nama in nama_karyawan_list %}
                                    <option value="{{ nama }}" {% if nama == nama_karyawan %}selected{% endif %}>{{ nama }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="tanggal_mulai" class="form-label">Tanggal Mulai:</label>
                            <input type="date" name="tanggal_mulai" id="tanggal_mulai" value="{{ tanggal_mulai }}" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label for="tanggal_selesai" class="form-label">Tanggal Selesai:</label>
                            <input type="date" name="tanggal_selesai" id="tanggal_selesai" value="{{ tanggal_selesai }}" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">Filter</button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#modalGajiDefault">
                                Set Gaji Default
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tabel Absensi -->
            <div class="card shadow mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Daftar Gaji Karyawan  </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        {% if attendance_list %}
                        <table class="table table-bordered table-hover align-middle text-center">
                            <thead class="table-primary text-black">
                                <tr>
                                    <th style="width: 50px;"><input type="checkbox" id="checkAll"></th>
                                    <th style="min-width: 100px;">ID Karyawan</th>
                                    <th style="min-width: 150px;">Nama</th>
                                    <th style="min-width: 160px;">Tanggal</th>
                                    <th style="min-width: 120px;">Gaji</th>
                                    <th style="min-width: 130px;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                    {% for a in attendance_list %}
                                    <tr class="{% if a.status_gaji == 'sudah diambil' %}table-secondary{% endif %}">
                                        <td>
                                            {% if a.status_gaji == 'sudah diambil' %}
                                                <!-- Tampilkan ikon centang hijau -->
                                                <i class="fas fa-check-circle text-success"></i>
                                            {% else %}
                                                <!-- Tampilkan checkbox biasa jika belum diambil -->
                                                <input type="checkbox" class="check-item" name="selected[]"
                                                    value="{{ a.id_karyawan }}"
                                                    data-gaji="{{ a.gaji }}"
                                                    data-status="{{ a.status_gaji|default('belum diambil') }}">
                                            {% endif %}
                                        </td>
                                        <td>{{ a.id_karyawan }}</td>
                                        <td>{{ a.nama }}</td>
                                        <td>{{ a.tanggal }}</td>
                                        <td class="gaji-value" data-status="{{ a.status }}">
                                            Rp {{ '{:,.0f}'.format(a.gaji).replace(',', '.') }}
                                        </td>
                                        <td class="status-gaji">{% if a.status_gaji == "sudah diambil" %}
                                            <span class="badge badge-success">Sudah diambil</span>
                                            {% else %}
                                            <span class="badge badge-secondary">Belum diambil</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <script>
                                    // Fungsi format Rupiah
                                    function formatRupiah(angka) {
                                        return 'Rp ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                                    }

                                    // Variabel global
                                    let selectedEmployeeData = {
                                        id: null,
                                        nama: null,
                                        items: [],
                                        totalGaji: 0
                                    };

                                    // Fungsi memuat kasbon dari backend
                                    async function loadKasbonData(employeeId) {
                                        try {
                                            const response = await fetch('/admin/ambil_kasbon', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ id_karyawan: employeeId })
                                            });

                                            const data = await response.json();
                                            if (data.success) {
                                                return {
                                                    total: data.kasbon || 0,
                                                    items: [{
                                                        tanggal: '-',
                                                        jumlah: data.kasbon || 0,
                                                        keterangan: 'Kasbon ' + (data.name || '')
                                                    }]
                                                };
                                            } else {
                                                console.error("Gagal memuat kasbon:", data.message);
                                                return { total: 0, items: [] };
                                            }
                                        } catch (error) {
                                            console.error("Error loading kasbon data:", error);
                                            return { total: 0, items: [] };
                                        }
                                    }

                                    // Fungsi utama untuk memperbarui tampilan
                                    function updateAksiTerpilih() {
                                        try {
                                            const checkboxes = document.querySelectorAll('.check-item:checked');
                                            const bottomBar = document.getElementById('bottomBar');
                                            if (!bottomBar) return;

                                            let total = 0;
                                            let count = checkboxes.length;
                                            let currentId = null;
                                            let invalidSelection = false;

                                            selectedEmployeeData = { id: null, nama: null, items: [], totalGaji: 0 };

                                            checkboxes.forEach(cb => {
                                                const row = cb.closest('tr');
                                                const id_karyawan = row.cells[1].textContent;
                                                const nama = row.cells[2].textContent;
                                                const gaji = parseInt(cb.dataset.gaji) || 0;

                                                if (currentId === null) {
                                                    currentId = id_karyawan;
                                                    selectedEmployeeData.id = id_karyawan;
                                                    selectedEmployeeData.nama = nama;
                                                } else if (currentId !== id_karyawan) {
                                                    invalidSelection = true;
                                                }

                                                selectedEmployeeData.items.push({
                                                    tanggal: row.cells[3].textContent.trim(),
                                                    status: row.cells[5].textContent.trim(),
                                                    gaji: gaji
                                                });

                                                total += gaji;
                                            });

                                            selectedEmployeeData.totalGaji = total;

                                            const totalGajiText = document.getElementById('totalGajiBottom');
                                            const jumlahText = document.getElementById('jumlahTerpilih');
                                            const ambilGajiBtn = bottomBar.querySelector('button');

                                            if (count > 0) {
                                                bottomBar.style.display = 'flex';

                                                if (invalidSelection) {
                                                    bottomBar.querySelector('.rounded-pill').classList.remove('bg-success');
                                                    bottomBar.querySelector('.rounded-pill').classList.add('bg-danger');
                                                    jumlahText.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Pilih ID karyawan sama';
                                                    totalGajiText.textContent = '';
                                                    ambilGajiBtn.disabled = true;
                                                    ambilGajiBtn.style.display = 'none';
                                                } else {
                                                    bottomBar.querySelector('.rounded-pill').classList.remove('bg-danger');
                                                    bottomBar.querySelector('.rounded-pill').classList.add('bg-success');
                                                    jumlahText.textContent = `${count} Item (${selectedEmployeeData.nama})`;
                                                    totalGajiText.textContent = formatRupiah(total);
                                                    ambilGajiBtn.disabled = false;
                                                    ambilGajiBtn.style.display = 'block';
                                                }
                                            } else {
                                                bottomBar.style.display = 'none';
                                            }
                                        } catch (error) {
                                            console.error("Error in updateAksiTerpilih:", error);
                                        }
                                    }

                                    // Fungsi untuk real-time update status gaji
                                    function setupRealtimeStatus() {
                                        const employeeId = selectedEmployeeData?.id;
                                        if (!employeeId) return;

                                        const statusRef = firebase.database().ref(`penggajian/${employeeId}`);
                                        statusRef.on('value', (snapshot) => {
                                            const data = snapshot.val();
                                            if (data) {
                                                document.querySelectorAll(`tr[data-employee="${employeeId}"] .status-gaji`).forEach(el => {
                                                    el.textContent = 'sudah diambil';
                                                });

                                                document.querySelectorAll(`.check-item[value="${employeeId}"]`).forEach(cb => {
                                                    cb.dataset.status = 'sudah diambil';
                                                });
                                            }
                                        });
                                    }

                                    // Inisialisasi event
                                    function initEventListeners() {
                                        document.querySelectorAll('.check-item').forEach(cb => {
                                            cb.addEventListener('change', updateAksiTerpilih);
                                        });

                                        const checkAll = document.getElementById('checkAll');
                                        if (checkAll) {
                                            checkAll.addEventListener('change', function () {
                                                document.querySelectorAll('.check-item').forEach(cb => {
                                                    cb.checked = this.checked;
                                                });
                                                updateAksiTerpilih();
                                            });
                                        }

                                        // Tombol ambil gaji (tampilkan modal)
                                        document.addEventListener('click', async function (e) {
                                            if (e.target.closest('#bottomBar button')) {
                                                if (!selectedEmployeeData.id) {
                                                    alert('Pilih karyawan terlebih dahulu');
                                                    return;
                                                }

                                                try {
                                                    // Isi data modal
                                                    document.getElementById('modalIdKaryawan').textContent = selectedEmployeeData.id;
                                                    document.getElementById('modalNamaKaryawan').textContent = selectedEmployeeData.nama;

                                                    // Isi detail gaji
                                                    const detailGajiBody = document.getElementById('detailGaji');
                                                    detailGajiBody.innerHTML = '';
                                                    selectedEmployeeData.items.forEach(item => {
                                                        detailGajiBody.innerHTML += `
                                                            <tr>
                                                                <td>${item.tanggal}</td>
                                                                <td>${item.status}</td>
                                                                <td>${formatRupiah(item.gaji)}</td>
                                                            </tr>
                                                        `;
                                                    });

                                                    document.getElementById('totalGajiModal').textContent = formatRupiah(selectedEmployeeData.totalGaji);

                                                    // Load data kasbon
                                                    const kasbonData = await loadKasbonData(selectedEmployeeData.id);
                                                    const detailKasbonBody = document.getElementById('detailKasbon');
                                                    detailKasbonBody.innerHTML = '';

                                                    if (kasbonData.items.length > 0) {
                                                        const item = kasbonData.items[0];
                                                        detailKasbonBody.innerHTML = `
                                                            <tr>
                                                                <td>${item.tanggal}</td>
                                                                <td>${formatRupiah(item.jumlah)}</td>
                                                                <td>${item.keterangan}</td>
                                                            </tr>
                                                        `;
                                                    } else {
                                                        detailKasbonBody.innerHTML = `
                                                            <tr>
                                                                <td colspan="3" class="text-center">Tidak ada data kasbon</td>
                                                            </tr>
                                                        `;
                                                    }

                                                    // Hitung dan tampilkan total kasbon dan sisa gaji
                                                    const totalKasbon = kasbonData.total || 0;
                                                    const sisaGaji = selectedEmployeeData.totalGaji - totalKasbon;
                                                    
                                                    document.getElementById('totalKasbonModal').textContent = formatRupiah(totalKasbon);
                                                    document.getElementById('sisaGajiModal').textContent = `Sisa Gaji: ${formatRupiah(sisaGaji)}`;
                                                    
                                                    // Cek sisa gaji dan atur tombol proses
                                                    const btnProses = document.getElementById('btnProsesAmbilGaji');
                                                    if (sisaGaji < 1) {
                                                        btnProses.disabled = true;
                                                        btnProses.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i> Gaji tidak cukup';
                                                        btnProses.classList.add('btn-danger');
                                                        btnProses.classList.remove('btn-primary');
                                                    } else {
                                                        btnProses.disabled = false;
                                                        btnProses.textContent = 'Proses Ambil Gaji';
                                                        btnProses.classList.add('btn-primary');
                                                        btnProses.classList.remove('btn-danger');
                                                    }

                                                    // Tampilkan modal
                                                    new bootstrap.Modal(document.getElementById('modalAmbilGaji')).show();
                                                    
                                                } catch (error) {
                                                    console.error("Error:", error);
                                                    Swal.fire({
                                                        icon: 'error',
                                                        title: 'Gagal',
                                                        text: 'Gagal memuat data kasbon',
                                                    });
                                                }
                                            }
                                        });

                                        // Proses ambil gaji
                                        document.getElementById('btnProsesAmbilGaji').addEventListener('click', async function() {
                                            if (!selectedEmployeeData.id) {
                                                alert('Pilih karyawan terlebih dahulu');
                                                return;
                                            }

                                            // Validasi sisa gaji sebelum memproses
                                            const totalGaji = selectedEmployeeData.totalGaji;
                                            const totalKasbon = parseInt(
                                                document.getElementById('totalKasbonModal').textContent.replace(/[^\d]/g, '')
                                            ) || 0;
                                            const sisaGaji = totalGaji - totalKasbon;

                                            if (sisaGaji < 1) {
                                                Swal.fire({
                                                    icon: 'error',
                                                    title: 'Tidak dapat diproses',
                                                    text: 'Gaji tidak bisa diambil karena sisa gaji kurang dari 1 Rupiah',
                                                    showConfirmButton: true
                                                });
                                                return;
                                            }

                                            // Tampilkan loading state
                                            const btn = this;
                                            btn.disabled = true;
                                            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memproses...';

                                            try {
                                                // Siapkan payload
                                                const payload = {
                                                    employeeId: selectedEmployeeData.id,
                                                    nama: selectedEmployeeData.nama,
                                                    detail: selectedEmployeeData.items.map(item => ({
                                                        tanggal: item.tanggal,
                                                        status: 'sudah diambil',
                                                        gaji: item.gaji,
                                                        id_jadwal: item.id_jadwal || null
                                                    })),
                                                    total_gaji: totalGaji,
                                                    total_kasbon: totalKasbon,
                                                    sisa_gaji: sisaGaji
                                                };

                                                // Kirim ke server
                                                const response = await fetch('/admin/proses_ambil_gaji', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify(payload)
                                                });

                                                // Tangani response
                                                if (!response.ok) {
                                                    const errorData = await response.json();
                                                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                                                }

                                                const result = await response.json();
                                                
                                                if (!result.success) {
                                                    throw new Error(result.message || 'Gagal memproses penggajian');
                                                }

                                                // Tampilkan notifikasi sukses
                                                const modal = bootstrap.Modal.getInstance(document.getElementById('modalAmbilGaji'));
                                                modal.hide();
                                                
                                                Swal.fire({
                                                    icon: 'success',
                                                    title: 'Berhasil!',
                                                    text: `Gaji ${result.data.nama} berhasil diproses dan kasbon dilunasi`,
                                                    showConfirmButton: false,
                                                    timer: 1500
                                                });

                                                // Update UI
                                                updateStatusGajiUI(selectedEmployeeData.id);
                                                
                                            } catch (error) {
                                                console.error('Error:', error);
                                                Swal.fire({
                                                    icon: 'success',
                                                    title: 'Berhasil',
                                                    text: error.message || 'Terjadi kesalahan saat memproses gaji',
                                                });
                                            } finally {
                                                btn.disabled = false;
                                                btn.textContent = 'Proses Ambil Gaji';
                                                btn.classList.add('btn-primary');
                                                btn.classList.remove('btn-danger');
                                                setTimeout(() => {
                                                    window.location.reload();
                                                }, 400);
                                            }
                                        });

                                        // Fungsi untuk update UI
                                        function updateStatusGajiUI(employeeId) {
                                            // Update checkbox
                                            document.querySelectorAll(`.check-item[value="${employeeId}"]`).forEach(el => {
                                                el.dataset.status = 'sudah diambil';
                                                el.checked = false;
                                            });
                                            
                                            // Update status di tabel
                                            document.querySelectorAll(`tr[data-employee="${employeeId}"] .status-gaji`).forEach(el => {
                                                el.textContent = 'sudah diambil';
                                                el.classList.add('text-success');
                                                el.classList.remove('text-danger');
                                            });
                                            
                                            // Reset selection
                                            document.getElementById('checkAll').checked = false;
                                            selectedEmployeeData = { id: null, nama: null, items: [], totalGaji: 0 };
                                            updateAksiTerpilih();
                                        }
                                    }

                                    // Inisialisasi Firebase dan event
                                    document.addEventListener('DOMContentLoaded', function () {
                                        if (!firebase.apps.length) {
                                            const firebaseConfig = {
                                                apiKey: "YOUR_API_KEY",
                                                authDomain: "YOUR_AUTH_DOMAIN",
                                                databaseURL: "https://facerecognition-c8264-default-rtdb.firebaseio.com/",
                                                projectId: "YOUR_PROJECT_ID",
                                                storageBucket: "YOUR_STORAGE_BUCKET",
                                                messagingSenderId: "YOUR_SENDER_ID",
                                                appId: "YOUR_APP_ID"
                                            };
                                            firebase.initializeApp(firebaseConfig);
                                        }

                                        initEventListeners();
                                        updateAksiTerpilih();
                                    });
                                </script>                                                                                                 
                            </tbody>
                        </table> 
                        <!-- Setelah </table> -->
                        <div id="bottomBar" class="d-flex fixed-bottom justify-content-center mb-3" style="display: none;">
                            <div class="bg-success text-white rounded-pill shadow p-3 d-flex align-items-center gap-3">
                                <div><strong id="jumlahTerpilih">0</strong> Karyawan Terpilih</div>
                                <div><strong id="totalGajiBottom">Rp 0</strong></div>
                                <button class="btn btn-light btn-sm text-success fw-bold" style="border-radius: 16px;">Ambil Gaji</button>
                            </div>
                        </div>                       
                        {% else %}
                        <div class="alert alert-info">Tidak ada data gaji karyawan</div>
                        {% endif %}
                    </div>                   
                </div>
            </div>
        </div>
        <!-- Modal Input Gaji Default -->
        <div class="modal fade" id="modalGajiDefault" tabindex="-1" aria-labelledby="modalGajiDefaultLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="formGajiDefault" method="POST" action="/admin/penggajian">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalGajiDefaultLabel">Set Gaji Default</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                        </div>
                        <div class="modal-body">
                            <label for="gaji_default" class="form-label">Masukkan Gaji Default (Rp):</label>
                            <input type="number" class="form-control" id="gaji_default" name="gaji_default" 
                                value="{{ gaji_default }}" min="0" required>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button type="submit" class="btn btn-primary">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Modal Ambil Gaji -->
        <div class="modal fade" id="modalAmbilGaji" tabindex="-1" aria-labelledby="modalAmbilGajiLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="modalAmbilGajiLabel">Ambil Gaji Karyawan</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Tutup"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>ID Karyawan: <span id="modalIdKaryawan" class="fw-bold"></span></h6>
                                <h6>Nama: <span id="modalNamaKaryawan" class="fw-bold"></span></h6>
                            </div>
                            <div class="col-md-6 text-end">
                                <h6>Periode: <span id="modalPeriode" class="fw-bold"></span></h6>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Rincian Gaji</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Tanggal</th>
                                                <th>Status</th>
                                                <th>Gaji</th>
                                            </tr>
                                        </thead>
                                        <tbody id="detailGaji">
                                            <!-- Data akan diisi oleh JavaScript -->
                                        </tbody>
                                        <tfoot class="table-primary">
                                            <tr>
                                                <th colspan="2">Total Gaji</th>
                                                <th id="totalGajiModal">Rp 0</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Rincian Kasbon</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Tanggal</th>
                                                <th>Jumlah</th>
                                                <th>Keterangan</th>
                                            </tr>
                                        </thead>
                                        <tbody id="detailKasbon">
                                            <!-- Data akan diisi oleh JavaScript -->
                                        </tbody>
                                        <tfoot class="table-primary">
                                            <tr>
                                                <th colspan="1">Total Kasbon</th>
                                                <th id="totalKasbonModal">Rp 0</th>
                                                <th id="sisaGajiModal">Sisa Gaji: Rp 0</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                        <button type="button" id="btnProsesAmbilGaji" class="btn btn-primary">Proses Ambil Gaji</button>
                    </div>
                </div>
            </div>
        </div>
    </div>              
    <script src="/static/vendor/jquery/jquery.min.js"></script>
    <script src="/static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
<script>
    // Fungsi untuk memuat gaji default dari Firebase saat modal dibuka
    document.getElementById('modalGajiDefault').addEventListener('show.bs.modal', function () {
        // Ambil gaji default dari Firebase
        const gajiDefaultRef = firebase.database().ref('default_gaji/default');
        gajiDefaultRef.once('value').then((snapshot) => {
            const gajiDefault = snapshot.val() ? snapshot.val().gaji : 10000;
            document.getElementById('gaji_default').value = gajiDefault;
        });
    });
    // Real-time listener untuk perubahan gaji default
    const gajiDefaultRef = firebase.database().ref('default_gaji/default');
    gajiDefaultRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            // Update semua nilai gaji di tabel yang sesuai
            document.querySelectorAll('.gaji-value').forEach(el => {
                const status = el.getAttribute('data-status');
                el.textContent = formatRupiah(status === 'Hadir' ? data.gaji : 0);
            });
        }
    });
</script>
</html>