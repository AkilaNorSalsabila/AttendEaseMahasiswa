<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Mahasiswa</title>

    <link href="/static/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="/static/css/sb-admin-2.min.css" rel="stylesheet">

    <style>
        .hidden {
            display: none;
        }

        .alert {
            margin-top: 20px;
        }

        iframe {
            border: 2px solid #4e73df;
            border-radius: 5px;
        }
    </style>
</head>

<body id="page-top">
    <div id="wrapper">
        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
            <!-- Sidebar Links -->
            <li class="nav-item">
                <a class="nav-link" href="/mahasiswa_dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/absen">
                    <i class="fas fa-check-circle"></i>
                    <span>Absen</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/rekap_absensi">
                    <i class="fas fa-list"></i>
                    <span>Rekap Absensi</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link logout" href="/logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </li>
        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <div id="content">
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button">
                                <span class="mr-2 d-none d-lg-inline text-gray-600 small">{{ mahasiswa.name }}</span>
                                <img class="img-profile rounded-circle" src="/static/img/undraw_profile.svg">
                            </a>
                        </li>
                    </ul>
                </nav>

    <div class="container-fluid">
        <div class="alert alert-warning text-center">
            <strong>Perhatian:</strong> Absensi hanya diperbolehkan dalam waktu maksimal <strong>15 menit</strong> setelah waktu yang dijadwalkan.
        </div>

        <!-- Form Absensi -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Informasi Mahasiswa</h6>
            </div>
            <div class="card-body">
                <p><strong>Nama:</strong> {{ mahasiswa.name }}</p>
                <p><strong>NIM:</strong> {{ mahasiswa.nim }}</p>
                <p><strong>Golongan:</strong> {{ mahasiswa.golongan }}</p>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Form Absensi</h6>
            </div>
            <div class="card-body">
                <form id="absensi-form" method="POST">
                    <div class="form-group">
                        <label for="mata_kuliah">Mata Kuliah:</label>
                        <select name="mata_kuliah" id="mata_kuliah" class="form-control" required>
                            <option value="" disabled selected>Pilih Mata Kuliah</option>
                            {% for mk in mata_kuliah_data %}
                            <option value="{{ mk.kode }}">{{ mk.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group mt-3">
                        <label for="minggu_ke">Minggu Ke:</label>
                        <select name="minggu_ke" id="minggu_ke" class="form-control" required>
                            <option value="" disabled selected>Pilih Minggu</option>
                            {% for i in range(1, 17) %}
                            <option value="minggu_ke_{{ i }}">Minggu ke-{{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" id="start-abse" class="btn btn-primary">Mulai Absen</button>
                </form>

                <!-- Display Status -->
                <div id="absen-status" class="hidden alert" role="alert">
                    <span id="status-text"></span>
                </div>

                <!-- Display Video Feed -->
                <div id="video-container" class="hidden">
                    <iframe id="video-feed" width="100%" height="400" frameborder="0"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('start-abse').addEventListener('click', function () {
            const mataKuliah = document.getElementById('mata_kuliah').value;
            const mingguKe = document.getElementById('minggu_ke').value;

            if (mataKuliah && mingguKe) {
                // Menyembunyikan form dan menampilkan video feed
                document.getElementById('absensi-form').classList.add('hidden');
                document.getElementById('video-container').classList.remove('hidden');

                // Membuka stream video feed
                const userId = "{{ mahasiswa.id }}"; // Pastikan ini dipassing dari backend
                const nim = "{{ mahasiswa.nim }}"; // Pastikan ini dipassing dari backend
                const videoUrl = `/video_feed/${userId}/${mataKuliah}/${mingguKe}/${nim}`;

                document.getElementById('video-feed').src = videoUrl;

                // Periksa status absensi setelah beberapa waktu
                setTimeout(() => {
                    checkAbsensiStatus(userId, mataKuliah, mingguKe);
                }, 5000); // Waktu tunggu untuk menyelesaikan absensi
            } else {
                alert("Pilih mata kuliah dan minggu ke terlebih dahulu!");
            }
        });

        function checkAbsensiStatus(user_id, mata_kuliah, minggu_ke) {
            const url = `/check_absen_status?user_id=${user_id}&mata_kuliah=${mata_kuliah}&minggu_ke=${minggu_ke}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById("absen-status");
                    const statusText = document.getElementById("status-text");

                    statusDiv.className = "alert"; // Reset alert class
                    statusDiv.classList.remove("hidden");

                    if (data.status === "success") {
                        statusText.textContent = "Absensi berhasil dicatat!";
                        statusDiv.classList.add("alert-success");
                    } else if (data.status === "pending") {
                        statusText.textContent = "Absensi belum dicatat. Mohon ulangi.";
                        statusDiv.classList.add("alert-warning");
                    } else {
                        statusText.textContent = "Terjadi kesalahan. Silakan hubungi admin.";
                        statusDiv.classList.add("alert-danger");
                    }
                })
                .catch(err => {
                    console.error("Error:", err);
                    alert("Terjadi kesalahan dalam memeriksa status absensi.");
                });
        }
    </script>
</body>

</html>
